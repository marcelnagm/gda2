<?php

/**
 * Skeleton subclass for representing a row from the 'tbfila' table.
 *
 * 
 *
 * This class was autogenerated by Propel 1.4.0 on:
 *
 * Tue May  4 12:14:36 2010
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    lib.model
 */
class Tbfila extends BaseTbfila {

    public function __construct() {
        parent::__construct();
        $this->setIdSituacao(0);
    }

    public function delete(PropelPDO $con = null) {
        $is_aluno = sfContext::getInstance()->getUser()->getAttribute('aluno');
        if (!isset($is_aluno)) {
            if ($this->getTbturma() != null) {
                if (TbturmaAlunoPeer::TurmaHasAluno($this->getMatricula(), $this->getTbturma()->getIdTurma()) == true) {
                    $this->removerDaTurma();
                }
            }
        }
        parent::delete($con);
    }

    public function save(PropelPDO $con = null) {
        Log::save($this);
        $is_aluno = sfContext::getInstance()->getUser()->getAttribute('aluno');
//        $is_matricula = sfContext::getInstance()->getUser()->getAttribute('novo_aluno');
        //caso a id_situacao esteja nessas situações remove da turma
        if (!isset($is_aluno)) {
//        if (!isset($is_aluno) && !isset($is_matricula)) {
            if ($this->getIdSituacao() != 1 && $this->getTbturma() != null) {
                if (TbturmaAlunoPeer::TurmaHasAluno($this->getMatricula(), $this->getTbturma()->getIdTurma()) == true) {
                    $this->removerDaTurma();
                }
            }
        }

        //verifica se e a disciplina trancamento de semestre
        if ($this->getTboferta()->getCodDisciplina() == 'ST999') {
            $criteria = new Criteria();
            $criteria->add(TbfilaPeer::MATRICULA, $this->getMatricula());
            $vars = new Tbfila();
            foreach (TbfilaPeer::doSelect($criteria) as $vars) {
                if ($vars->getTboferta()->getIdPeriodo() == $this->getTboferta()->getIdPeriodo()) {
                    if ($vars->getTboferta()->getCodDisciplina() != 'ST999') {
                        $fila = $vars->copy();
                        $fila->setIdSituacao(12);
                        $fila->save();

                        $vars->delete();
                    }
                }
            }
        }

//        //verifca se o id_situacao = aceito
        if (!isset($is_aluno)) {
            if ($this->getIdSituacao() == 1) {
                //se existir a turma
                if ($this->getTbturma() != null) {
                    //se o aluno não estiver incluido na turma inclui-lo
                    if (TbturmaAlunoPeer::TurmaHasAluno($this->getMatricula(), $this->getTbturma()->getIdTurma()) == false) {
                        $turma_aluno = new TbturmaAluno();
                        $turma_aluno->setMatricula($this->getMatricula());
                        $turma_aluno->setIdTurma($this->getTbturma()->getIdTurma());
                        $turma_aluno->save();
                    }
                }
            }
        }

        parent::save($con);
    }

    /**
     * Retorna o Tbturma associado ao id_oferta do tbfila
     * Pode retornar NULL se não tiver uma turma associada
     * @return <mixed>  Tbturma
     */
    public function getTbturma() {
        $criteria = new Criteria();
        $criteria->add(TbturmaPeer::ID_OFERTA, $this->getIdOferta());
        if (TbturmaPeer::doCount($criteria) == 1) {
            return TbturmaPeer::doSelectOne($criteria);
        } else {
            return null;
        }
    }

    public function removerDaTurma() {
        $criteria = new Criteria();
        $criteria->add(TbturmaAlunoPeer::ID_TURMA, $this->getTbturma()->getIdTurma());
        $criteria->add(TbturmaAlunoPeer::MATRICULA, $this->getMatricula());
        TbturmaAlunoPeer::doSelectOne($criteria)->delete();
    }

//    public function setIdOferta($v) {
//        if($v != $this->getIdOferta()){
//            if($this->getTbturma() != null){
//                //se o aluno não estiver incluido na turma inclui-lo
//                if (TbturmaAlunoPeer::TurmaHasAluno($this->getMatricula(), $this->getTbturma()->getIdTurma()) == true) {
//                    $this->removerDaTurma();
//                }
//            }
//        }
//        parent::setIdOferta($v);
//    }
}

// Tbfila
